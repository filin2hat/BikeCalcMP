name: ğŸš´â€â™‚ï¸ BikeCalc Pro CI/CD

on:
  push:
    branches: ['master', 'develop', 'feature/**', 'task/**']
  pull_request:
    branches: ['master', 'develop']
  workflow_dispatch:

env:
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.daemon=false -Dkotlin.incremental=false"

jobs:
  # ===============================================
  # ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ• Ğ˜ Ğ›Ğ˜ĞĞ¢Ğ˜ĞĞ“
  # ===============================================
  test:
    name: ğŸ§ª Tests & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Debug Info
        run: |
          echo "ğŸ” Debug Information:"
          echo "Branch: ${{ github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Commit Message: ${{ github.event.head_commit.message }}"

      - name: ğŸ”§ Make gradlew executable
        run: chmod +x gradlew
        shell: bash

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-home-cache-cleanup: true

      - name: ğŸ” Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: ğŸ§ª Run Unit Tests (KMP modules only)
        run: ./gradlew :data:pressure:desktopTest --parallel --build-cache

      - name: ğŸ” Run Detekt Analysis
        run: ./gradlew detekt --parallel
        shell: bash

      - name: ğŸ“¦ Upload Test & Lint Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-and-lint-reports
          path: |
            **/build/reports/**
            **/build/test-results/**
          retention-days: 7

      # Report step removed as requested

  # ===============================================
  # ğŸ—ï¸ ĞœĞĞ”Ğ£Ğ›Ğ¬ĞĞĞ¯ Ğ¡Ğ‘ĞĞ ĞšĞ
  # ===============================================
  build-modules:
    name: ğŸ—ï¸ Build Modules
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: test

    strategy:
      fail-fast: false
      matrix:
        module: 
          - ":core:model"
          - ":core:common" 
          - ":core:database"
          - ":domain:pressure"
          - ":domain:development"
          - ":data:pressure"
          - ":data:development"
          - ":designsystem"
          - ":feature:pressure"
          - ":feature:development"

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Make gradlew executable
        run: chmod +x gradlew
        shell: bash

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ğŸ”¨ Build Module ${{ matrix.module }}
        run: ./gradlew ${{ matrix.module }}:build --parallel --build-cache

      - name: ğŸ“¦ Upload Module Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ matrix.module }}
          path: ${{ matrix.module }}/build/reports/**
          retention-days: 7

      - name: ğŸ“¦ Upload Module Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: module-${{ matrix.module }}-artifacts
          path: |
            ${{ matrix.module }}/build/libs/
            ${{ matrix.module }}/build/outputs/
          retention-days: 1

  # ===============================================
  # ğŸ“± ANDROID Ğ¡Ğ‘ĞĞ ĞšĞ
  # ===============================================
  build-android:
    name: ğŸ“± Android Build
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test, build-modules]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Make gradlew executable
        run: chmod +x gradlew
        shell: bash

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ğŸ”¨ Build Debug APK
        run: ./gradlew :composeApp:assembleDebug --parallel --build-cache

      - name: ğŸ”¨ Build Release APK
        run: ./gradlew :composeApp:assembleRelease --parallel --build-cache

      - name: ğŸ“¦ Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: ğŸ“± Android Debug APK
          path: composeApp/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: ğŸ“¦ Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: ğŸ“± Android Release APK
          path: composeApp/build/outputs/apk/release/*.apk
          retention-days: 30

  # ===============================================
  # ğŸ–¥ï¸ DESKTOP Ğ¡Ğ‘ĞĞ ĞšĞ
  # ===============================================
  build-desktop:
    name: ğŸ–¥ï¸ Desktop Build
    runs-on: ${{ matrix.os }}
    timeout-minutes: 25
    needs: [test, build-modules]

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Make gradlew executable
        run: chmod +x gradlew
        shell: bash

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ğŸ”¨ Build Desktop App
        run: ./gradlew :composeApp:createDistributable --parallel --build-cache
        shell: bash

      - name: ğŸ“¦ Upload Desktop Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ğŸ–¥ï¸ Desktop App (${{ matrix.os }})
          path: composeApp/build/compose/binaries/main/app/
          retention-days: 7

  # ===============================================
  # ğŸ iOS Ğ¡Ğ‘ĞĞ ĞšĞ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° macOS)
  # ===============================================
  build-ios:
    name: ğŸ iOS Build
    runs-on: macos-latest
    timeout-minutes: 35
    needs: [test, build-modules]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Make gradlew executable
        run: chmod +x gradlew
        shell: bash

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ğŸ”¨ Compile iOS Target
        run: ./gradlew :composeApp:compileKotlinIosArm64 --parallel --build-cache
        shell: bash

      - name: ğŸ”¨ Compile iOS Simulator Target
        run: ./gradlew :composeApp:compileKotlinIosX64 --parallel --build-cache
        shell: bash

      - name: ğŸ“¦ Upload iOS Compilation Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ğŸ iOS Compilation Reports
          path: composeApp/build/reports/
          retention-days: 7

  # ===============================================
  # ğŸ“Š ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ ĞĞ«Ğ™ ĞĞĞĞ›Ğ˜Ğ—
  # ===============================================
  architecture-analysis:
    name: ğŸ“Š Architecture Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: test

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Make gradlew executable
        run: chmod +x gradlew
        shell: bash

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ğŸ” Check Dependencies
        run: ./gradlew :composeApp:dependencies --configuration debugCompileClasspath

      - name: ğŸ“Š Generate Dependency Graph
        run: ./gradlew generateModuleGraphDot || echo "Module graph generation skipped"

      - name: ğŸ“ˆ Build Time Analysis
        run: ./gradlew :composeApp:assembleDebug --build-cache --parallel --profile

      - name: ğŸ“¦ Upload Build Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ğŸ“Š Build Reports
          path: |
            build/reports/
            **/build/reports/
          retention-days: 7

  # ===============================================
  # âœ… Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞĞ¯ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ
  # ===============================================
  final-check:
    name: âœ… Final Validation
    runs-on: ubuntu-latest
    needs: [build-android, build-desktop, build-ios, architecture-analysis]
    if: always()

    steps:
      - name: ğŸ“ Write Job Summary
        shell: bash
        run: |
          echo "## ğŸ“‹ CI Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ğŸ”„ Jobs status" >> "$GITHUB_STEP_SUMMARY"
          echo "- ğŸ§ª Tests: ${{ needs.test.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- ğŸ“± Android: ${{ needs.build-android.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- ğŸ–¥ï¸ Desktop: ${{ needs.build-desktop.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- ğŸ iOS: ${{ needs.build-ios.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- ğŸ“Š Analysis: ${{ needs.architecture-analysis.result }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ğŸ“¦ Artifacts" >> "$GITHUB_STEP_SUMMARY"
          echo "- Test/Lint reports: test-and-lint-reports" >> "$GITHUB_STEP_SUMMARY"
          echo "- Module reports: reports-:core:model, reports-:core:common, reports-:core:database, reports-:domain:pressure, reports-:domain:development, reports-:data:pressure, reports-:data:development, reports-:designsystem, reports-:feature:pressure, reports-:feature:development" >> "$GITHUB_STEP_SUMMARY"

      - name: ğŸ“ Save CI Summary file
        shell: bash
        run: |
          cat > ci-summary.md << 'EOF'
          # ğŸ“‹ CI Summary

          ## ğŸ”„ Jobs status
          - ğŸ§ª Tests: ${{ needs.test.result }}
          - ğŸ“± Android: ${{ needs.build-android.result }}
          - ğŸ–¥ï¸ Desktop: ${{ needs.build-desktop.result }}
          - ğŸ iOS: ${{ needs.build-ios.result }}
          - ğŸ“Š Analysis: ${{ needs.architecture-analysis.result }}

          ## ğŸ“¦ Artifacts
          - Test/Lint reports: test-and-lint-reports
          - Module reports: reports-:core:model, reports-:core:common, reports-:core:database, reports-:domain:pressure, reports-:domain:development, reports-:data:pressure, reports-:data:development, reports-:designsystem, reports-:feature:pressure, reports-:feature:development
          EOF

      - name: ğŸ“¤ Upload CI Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-summary
          path: ci-summary.md
          retention-days: 7
      - name: ğŸ“Š Check Build Results
        run: |
          echo "ğŸ‰ Build Status Summary:"
          echo "âœ… Tests: ${{ needs.test.result }}"
          echo "ğŸ“± Android: ${{ needs.build-android.result }}"
          echo "ğŸ–¥ï¸ Desktop: ${{ needs.build-desktop.result }}"
          echo "ğŸ iOS: ${{ needs.build-ios.result }}"
          echo "ğŸ“Š Analysis: ${{ needs.architecture-analysis.result }}"

      - name: ğŸš€ Success Notification
        if: ${{ needs.build-android.result == 'success' && needs.build-desktop.result == 'success' }}
        run: echo "ğŸ‰ Ğ’ÑĞµ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ñ‹! ĞœĞ½Ğ¾Ğ³Ğ¾Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒĞ½Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾!"
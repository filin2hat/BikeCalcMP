name: 🚴‍♂️ BikeCalc Pro CI/CD

on:
  push:
    branches: ['main', 'develop', 'feature/**']
  pull_request:
    branches: ['main', 'develop']
  workflow_dispatch:

env:
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.daemon=false -Dkotlin.incremental=false"

jobs:
  # ===============================================
  # 🧪 ТЕСТИРОВАНИЕ И ЛИНТИНГ
  # ===============================================
  test:
    name: 🧪 Tests & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ☕ Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: 🐘 Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-home-cache-cleanup: true

      - name: 🔍 Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: 🧪 Run Unit Tests (KMP modules only)
        run: ./gradlew :data:pressure:allTests --parallel --build-cache

      - name: 🔍 Run Detekt Analysis
        run: ./gradlew detekt --parallel

      - name: 📊 Generate Test Report
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: 📊 Test Results
          path: '**/build/test-results/test*/*.xml'
          reporter: java-junit

  # ===============================================
  # 🏗️ МОДУЛЬНАЯ СБОРКА
  # ===============================================
  build-modules:
    name: 🏗️ Build Modules
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: test

    strategy:
      fail-fast: false
      matrix:
        module: 
          - ":core:model"
          - ":core:common" 
          - ":core:database"
          - ":domain:pressure"
          - ":data:pressure"
          - ":designsystem"
          - ":feature:pressure"

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: ☕ Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: 🐘 Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: 🔨 Build Module ${{ matrix.module }}
        run: ./gradlew ${{ matrix.module }}:build --parallel --build-cache

      - name: 📦 Upload Module Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: module-${{ matrix.module }}-artifacts
          path: |
            ${{ matrix.module }}/build/libs/
            ${{ matrix.module }}/build/outputs/
          retention-days: 1

  # ===============================================
  # 📱 ANDROID СБОРКА
  # ===============================================
  build-android:
    name: 📱 Android Build
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test, build-modules]

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: ☕ Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: 🐘 Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: 🔨 Build Debug APK
        run: ./gradlew :composeApp:assembleDebug --parallel --build-cache

      - name: 🔨 Build Release APK
        run: ./gradlew :composeApp:assembleRelease --parallel --build-cache

      - name: 📦 Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: 📱 Android Debug APK
          path: composeApp/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: 📦 Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: 📱 Android Release APK
          path: composeApp/build/outputs/apk/release/*.apk
          retention-days: 30

  # ===============================================
  # 🖥️ DESKTOP СБОРКА
  # ===============================================
  build-desktop:
    name: 🖥️ Desktop Build
    runs-on: ${{ matrix.os }}
    timeout-minutes: 25
    needs: [test, build-modules]

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: ☕ Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: 🐘 Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: 🔨 Build Desktop App
        run: ./gradlew :composeApp:createDistributable --parallel --build-cache

      - name: 📦 Upload Desktop Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: 🖥️ Desktop App (${{ matrix.os }})
          path: composeApp/build/compose/binaries/main/app/
          retention-days: 7

  # ===============================================
  # 🍎 iOS СБОРКА (только на macOS)
  # ===============================================
  build-ios:
    name: 🍎 iOS Build
    runs-on: macos-latest
    timeout-minutes: 35
    needs: [test, build-modules]

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: ☕ Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: 🐘 Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: 🍎 Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: 🔨 Build iOS Framework
        run: ./gradlew :composeApp:embedAndSignAppleFrameworkForXcode --parallel --build-cache

      - name: 📦 Upload iOS Framework
        uses: actions/upload-artifact@v4
        with:
          name: 🍎 iOS Framework
          path: composeApp/build/xcode-frameworks/
          retention-days: 7

  # ===============================================
  # 📊 АРХИТЕКТУРНЫЙ АНАЛИЗ
  # ===============================================
  architecture-analysis:
    name: 📊 Architecture Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: test

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: ☕ Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: 🐘 Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: 🔍 Check Dependencies
        run: ./gradlew :composeApp:dependencies --configuration debugCompileClasspath

      - name: 📊 Generate Dependency Graph
        run: ./gradlew generateModuleGraphDot || echo "Module graph generation skipped"

      - name: 📈 Build Time Analysis
        run: ./gradlew :composeApp:assembleDebug --build-cache --parallel --profile

      - name: 📦 Upload Build Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: 📊 Build Reports
          path: |
            build/reports/
            **/build/reports/
          retention-days: 7

  # ===============================================
  # ✅ ФИНАЛЬНАЯ ПРОВЕРКА
  # ===============================================
  final-check:
    name: ✅ Final Validation
    runs-on: ubuntu-latest
    needs: [build-android, build-desktop, build-ios, architecture-analysis]
    if: always()

    steps:
      - name: 📊 Check Build Results
        run: |
          echo "🎉 Build Status Summary:"
          echo "✅ Tests: ${{ needs.test.result }}"
          echo "📱 Android: ${{ needs.build-android.result }}"
          echo "🖥️ Desktop: ${{ needs.build-desktop.result }}"
          echo "🍎 iOS: ${{ needs.build-ios.result }}"
          echo "📊 Analysis: ${{ needs.architecture-analysis.result }}"

      - name: 🚀 Success Notification
        if: ${{ needs.build-android.result == 'success' && needs.build-desktop.result == 'success' }}
        run: echo "🎉 Все платформы успешно собраны! Многомодульная архитектура работает отлично!"
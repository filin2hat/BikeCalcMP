name: ğŸš´â€â™‚ï¸ BikeCalc Pro CI/CD

on:
  push:
    branches: ['main', 'develop', 'feature/**']
  pull_request:
    branches: ['main', 'develop']
  workflow_dispatch:

env:
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.daemon=false -Dkotlin.incremental=false"

jobs:
  # ===============================================
  # ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ• Ğ˜ Ğ›Ğ˜ĞĞ¢Ğ˜ĞĞ“
  # ===============================================
  test:
    name: ğŸ§ª Tests & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-home-cache-cleanup: true

      - name: ğŸ” Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: ğŸ§ª Run Unit Tests (KMP modules only)
        run: ./gradlew :data:pressure:allTests --parallel --build-cache

      - name: ğŸ” Run Detekt Analysis
        run: ./gradlew detekt --parallel

      - name: ğŸ“Š Generate Test Report
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: ğŸ“Š Test Results
          path: '**/build/test-results/test*/*.xml'
          reporter: java-junit

  # ===============================================
  # ğŸ—ï¸ ĞœĞĞ”Ğ£Ğ›Ğ¬ĞĞĞ¯ Ğ¡Ğ‘ĞĞ ĞšĞ
  # ===============================================
  build-modules:
    name: ğŸ—ï¸ Build Modules
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: test

    strategy:
      fail-fast: false
      matrix:
        module: 
          - ":core:model"
          - ":core:common" 
          - ":core:database"
          - ":domain:pressure"
          - ":data:pressure"
          - ":designsystem"
          - ":feature:pressure"

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ğŸ”¨ Build Module ${{ matrix.module }}
        run: ./gradlew ${{ matrix.module }}:build --parallel --build-cache

      - name: ğŸ“¦ Upload Module Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: module-${{ matrix.module }}-artifacts
          path: |
            ${{ matrix.module }}/build/libs/
            ${{ matrix.module }}/build/outputs/
          retention-days: 1

  # ===============================================
  # ğŸ“± ANDROID Ğ¡Ğ‘ĞĞ ĞšĞ
  # ===============================================
  build-android:
    name: ğŸ“± Android Build
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test, build-modules]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ğŸ”¨ Build Debug APK
        run: ./gradlew :composeApp:assembleDebug --parallel --build-cache

      - name: ğŸ”¨ Build Release APK
        run: ./gradlew :composeApp:assembleRelease --parallel --build-cache

      - name: ğŸ“¦ Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: ğŸ“± Android Debug APK
          path: composeApp/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: ğŸ“¦ Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: ğŸ“± Android Release APK
          path: composeApp/build/outputs/apk/release/*.apk
          retention-days: 30

  # ===============================================
  # ğŸ–¥ï¸ DESKTOP Ğ¡Ğ‘ĞĞ ĞšĞ
  # ===============================================
  build-desktop:
    name: ğŸ–¥ï¸ Desktop Build
    runs-on: ${{ matrix.os }}
    timeout-minutes: 25
    needs: [test, build-modules]

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ğŸ”¨ Build Desktop App
        run: ./gradlew :composeApp:createDistributable --parallel --build-cache

      - name: ğŸ“¦ Upload Desktop Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ğŸ–¥ï¸ Desktop App (${{ matrix.os }})
          path: composeApp/build/compose/binaries/main/app/
          retention-days: 7

  # ===============================================
  # ğŸ iOS Ğ¡Ğ‘ĞĞ ĞšĞ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° macOS)
  # ===============================================
  build-ios:
    name: ğŸ iOS Build
    runs-on: macos-latest
    timeout-minutes: 35
    needs: [test, build-modules]

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ğŸ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: ğŸ”¨ Build iOS Framework
        run: ./gradlew :composeApp:embedAndSignAppleFrameworkForXcode --parallel --build-cache

      - name: ğŸ“¦ Upload iOS Framework
        uses: actions/upload-artifact@v4
        with:
          name: ğŸ iOS Framework
          path: composeApp/build/xcode-frameworks/
          retention-days: 7

  # ===============================================
  # ğŸ“Š ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ ĞĞ«Ğ™ ĞĞĞĞ›Ğ˜Ğ—
  # ===============================================
  architecture-analysis:
    name: ğŸ“Š Architecture Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: test

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'temurin'

      - name: ğŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ğŸ” Check Dependencies
        run: ./gradlew :composeApp:dependencies --configuration debugCompileClasspath

      - name: ğŸ“Š Generate Dependency Graph
        run: ./gradlew generateModuleGraphDot || echo "Module graph generation skipped"

      - name: ğŸ“ˆ Build Time Analysis
        run: ./gradlew :composeApp:assembleDebug --build-cache --parallel --profile

      - name: ğŸ“¦ Upload Build Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ğŸ“Š Build Reports
          path: |
            build/reports/
            **/build/reports/
          retention-days: 7

  # ===============================================
  # âœ… Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞĞ¯ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ
  # ===============================================
  final-check:
    name: âœ… Final Validation
    runs-on: ubuntu-latest
    needs: [build-android, build-desktop, build-ios, architecture-analysis]
    if: always()

    steps:
      - name: ğŸ“Š Check Build Results
        run: |
          echo "ğŸ‰ Build Status Summary:"
          echo "âœ… Tests: ${{ needs.test.result }}"
          echo "ğŸ“± Android: ${{ needs.build-android.result }}"
          echo "ğŸ–¥ï¸ Desktop: ${{ needs.build-desktop.result }}"
          echo "ğŸ iOS: ${{ needs.build-ios.result }}"
          echo "ğŸ“Š Analysis: ${{ needs.architecture-analysis.result }}"

      - name: ğŸš€ Success Notification
        if: ${{ needs.build-android.result == 'success' && needs.build-desktop.result == 'success' }}
        run: echo "ğŸ‰ Ğ’ÑĞµ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ñ‹! ĞœĞ½Ğ¾Ğ³Ğ¾Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒĞ½Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾!"